version: '3.3'

services:
  faq-vue:
    build:
      context: ./vuejs
      dockerfile: Dockerfile
      args:
          - http_proxy=$http_proxy
          - https_proxy=$http_proxy
    container_name: faq-vue
    networks:
      - web
    ports:
      - 25252:8080
    volumes:
      - './vuejs/sources/:/app:rw'
      - './protos:/app/src/protos:ro'
    tty: true

  faq-api:
    build:
      context: ./flask
      dockerfile: Dockerfile
      args:
          - http_proxy=$http_proxy
          - https_proxy=$http_proxy
    container_name: faq-api
    networks:
      - web
    ports:
      - 8282:8080
    volumes:
      - './flask/sources/:/app:rw'
      - './protos/:/app/protos:ro'
    tty: true

  faq-proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
      args:
        - http_proxy=$http_proxy
        - https_proxy=$http_proxy
    container_name: faq-proxy
    networks:
      - web
    ports:
      - 8001:8001
    links:
      - faq-grpc

  faq-grpc:
    build:
      context: ./grpc
      dockerfile: Dockerfile
      args:
          - http_proxy=$http_proxy
          - https_proxy=$http_proxy
    container_name: faq-grpc
    networks:
      - web
      - dbnw
    ports:
      - 50051:50051
    env_file:
      - .env
    volumes:
      - './grpc/sources/:/app:rw'
      - './protos/:/app/protos:rw'
    labels:
      - trafik.enable=false
    tty: true

  faq-db:
    build:
      context: ./db
      dockerfile: Dockerfile
      args:
          - http_proxy=$http_proxy
          - https_proxy=$http_proxy
    networks:
      - dbnw
    container_name: faq-db
    volumes:
      - 'faq_vol:/var/lib/mysql:rw'
      - './db/:/var/tmp:rw'
    labels:
      # traefik で監視・リバースプロキシしない
      - 'traefik.enable=false'
    ports:
      - 3306:3306
    tty: true
    labels:
      - trafik.enable=false
    env_file:
      - .env

volumes:
  faq_vol:

networks:
  dbnw:
  web:
